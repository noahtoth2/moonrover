#include <WiFi.h>
#include <WebServer.h>
#include <ArduinoOTA.h>
#include <PubSubClient.h>

// =================== Pines del L298N ===================
// PUENTE H #1 (4 motores en paralelo ‚Üí 2 motores l√≥gicos)
const int IN1_H1 = 1;   // H1-A adelante
const int IN2_H1 = 2;   // H1-A atr√°s
const int IN3_H1 = 3;   // H1-B adelante
const int IN4_H1 = 4;   // H1-B atr√°s

// PUENTE H #2 (2 motores ‚Üí 2 motores l√≥gicos)
const int IN1_H2 = 5;   // H2-A adelante
const int IN2_H2 = 6;   // H2-A atr√°s
const int IN3_H2 = 7;   // H2-B adelante
const int IN4_H2 = 8;   // H2-B atr√°s

// =================== Pines PWM ===================
// Motores l√≥gicos
const int PWM_H1_A = 9;     // Puente 1 - Motor A (izquierdo frontal, 2 motores)
const int PWM_H1_B = 10;    // Puente 1 - Motor B (derecho frontal, 2 motores)
const int PWM_H2_A = 11;    // Puente 2 - Motor A (izquierdo trasero)
const int PWM_H2_B = 12;    // Puente 2 - Motor B (derecho trasero)

// =================== Config PWM ===================
const int FREQ_PWM = 20000;    // 20 kHz ‚Üí silencioso y estable
const int RES_PWM = 10;        // 10 bits ‚Üí 0-1023
int velocidad = 900;           // velocidad por defecto

const int CH_H1_A = 0;
const int CH_H1_B = 1;
const int CH_H2_A = 2;
const int CH_H2_B = 3;

// =================== WiFi ===================
const char* ssid = "roverlunar";
const char* password = "rover123";

// =================== MQTT ===================
const char* mqtt_server = "192.168.1.100";
const int mqtt_port = 1883;
const char* mqtt_topic = "rover/control";
const char* mqtt_client_id = "RoverESP32";

WiFiClient espClient;
PubSubClient mqttClient(espClient);

// =================== Servidor HTTP ===================
WebServer server(80);

// =================== Seguridad ===================
unsigned long ultimoComando = 0;
const unsigned long TIMEOUT_SEGURIDAD = 2000;
bool motorActivo = false;

// =================== Prototipos ===================
void adelante();
void atras();
void izquierda();
void derecha();
void detenerMotores();
void reconnectMQTT();
void callback(char* topic, byte* payload, unsigned int length);

// =================== SETUP ===================
void setup() {
  Serial.begin(115200);
  delay(300);

  // Direcci√≥n L298N
  pinMode(IN1_H1, OUTPUT);
  pinMode(IN2_H1, OUTPUT);
  pinMode(IN3_H1, OUTPUT);
  pinMode(IN4_H1, OUTPUT);

  pinMode(IN1_H2, OUTPUT);
  pinMode(IN2_H2, OUTPUT);
  pinMode(IN3_H2, OUTPUT);
  pinMode(IN4_H2, OUTPUT);

  // PWM Setup
  ledcSetup(CH_H1_A, FREQ_PWM, RES_PWM);
  ledcSetup(CH_H1_B, FREQ_PWM, RES_PWM);
  ledcSetup(CH_H2_A, FREQ_PWM, RES_PWM);
  ledcSetup(CH_H2_B, FREQ_PWM, RES_PWM);

  ledcAttachPin(PWM_H1_A, CH_H1_A);
  ledcAttachPin(PWM_H1_B, CH_H1_B);
  ledcAttachPin(PWM_H2_A, CH_H2_A);
  ledcAttachPin(PWM_H2_B, CH_H2_B);

  detenerMotores();

  // =================== Conectar WiFi ===================
  Serial.println("Conectando al WiFi...");
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);

  unsigned long startAttemptTime = millis();
  while (WiFi.status() != WL_CONNECTED && millis() - startAttemptTime < 20000) {
    delay(300);
    Serial.print(".");
  }

  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("\n‚ùå No se pudo conectar. Reiniciando...");
    delay(1000);
    ESP.restart();
  }

  Serial.println("\n‚úÖ WiFi conectado!");
  Serial.print("IP: ");
  Serial.println(WiFi.localIP());

  // =================== MQTT ===================
  mqttClient.setServer(mqtt_server, mqtt_port);
  mqttClient.setCallback(callback);
  reconnectMQTT();

  // =================== Endpoints HTTP ===================
  server.on("/forward", []() { adelante(); ultimoComando = millis(); motorActivo = true; server.send(200, "text/plain", "Adelante"); });
  server.on("/backward", []() { atras(); ultimoComando = millis(); motorActivo = true; server.send(200, "text/plain", "Atras"); });
  server.on("/left", []() { izquierda(); ultimoComando = millis(); motorActivo = true; server.send(200, "text/plain", "Izquierda"); });
  server.on("/right", []() { derecha(); ultimoComando = millis(); motorActivo = true; server.send(200, "text/plain", "Derecha"); });
  server.on("/stop", []() { detenerMotores(); ultimoComando = millis(); motorActivo = false; server.send(200, "text/plain", "Stop"); });

  server.on("/", []() { server.send(200, "text/plain", "Rover OK - PWM Enabled"); });

  server.begin();
  Serial.println("üåê Servidor HTTP listo.");

  // =================== OTA ===================
  ArduinoOTA.setHostname("RoverMotor");
  ArduinoOTA.setPassword("123");

  ArduinoOTA.onStart([]() {
    detenerMotores();
    Serial.println("üîÑ Iniciando actualizaci√≥n OTA");
  });

  ArduinoOTA.onEnd([]() {
    Serial.println("\n‚úÖ OTA completada");
  });

  ArduinoOTA.begin();
  Serial.println("üì° OTA habilitado");
}

// =================== LOOP ===================
void loop() {
  ArduinoOTA.handle();
  if (!mqttClient.connected()) reconnectMQTT();
  mqttClient.loop();
  server.handleClient();

  unsigned long t = millis();

  if (motorActivo && t - ultimoComando > TIMEOUT_SEGURIDAD) {
    Serial.println("üõë TIMEOUT - Deteniendo por seguridad");
    detenerMotores();
    motorActivo = false;
  }

  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("‚ùå WiFi perdido - Deteniendo motores");
    detenerMotores();
    motorActivo = false;
    ESP.restart();
  }

  delay(10);
}

// =================== MQTT CALLBACK ===================
void callback(char* topic, byte* payload, unsigned int length) {
  String msg = "";
  for (int i = 0; i < length; i++) msg += (char)payload[i];

  Serial.println("üì© MQTT: " + msg);
  ultimoComando = millis();

  if (msg == "forward") adelante();
  else if (msg == "backward") atras();
  else if (msg == "left") izquierda();
  else if (msg == "right") derecha();
  else if (msg == "stop") detenerMotores();
}

// =================== MQTT RECONNECT ===================
void reconnectMQTT() {
  if (!mqttClient.connected()) {
    Serial.print("üîÑ Conectando a MQTT...");
    if (mqttClient.connect(mqtt_client_id)) {
      Serial.println(" OK");
      mqttClient.subscribe(mqtt_topic);
    } else {
      Serial.println(" ERROR, reintentando...");
    }
  }
}

// =================== MOVIMIENTOS ===================

void adelante() {
  Serial.println("‚¨ÜÔ∏è Adelante");

  // Direcci√≥n
  digitalWrite(IN1_H1, HIGH); digitalWrite(IN2_H1, LOW);
  digitalWrite(IN3_H1, LOW);  digitalWrite(IN4_H1, HIGH);
  digitalWrite(IN1_H2, LOW);  digitalWrite(IN2_H2, HIGH);
  digitalWrite(IN3_H2, HIGH); digitalWrite(IN4_H2, LOW);

  // Velocidad PWM
  ledcWrite(CH_H1_A, velocidad);
  ledcWrite(CH_H1_B, velocidad);
  ledcWrite(CH_H2_A, velocidad);
  ledcWrite(CH_H2_B, velocidad);
}

void atras() {
  Serial.println("‚¨áÔ∏è Atras");

  digitalWrite(IN1_H1, LOW);  digitalWrite(IN2_H1, HIGH);
  digitalWrite(IN3_H1, HIGH); digitalWrite(IN4_H1, LOW);
  digitalWrite(IN1_H2, HIGH); digitalWrite(IN2_H2, LOW);
  digitalWrite(IN3_H2, LOW);  digitalWrite(IN4_H2, HIGH);

  ledcWrite(CH_H1_A, velocidad);
  ledcWrite(CH_H1_B, velocidad);
  ledcWrite(CH_H2_A, velocidad);
  ledcWrite(CH_H2_B, velocidad);
}

void izquierda() {
  Serial.println("‚¨ÖÔ∏è Izquierda");

  digitalWrite(IN1_H1, LOW);  digitalWrite(IN2_H1, HIGH);
  digitalWrite(IN3_H1, LOW);  digitalWrite(IN4_H1, HIGH);

  digitalWrite(IN1_H2, HIGH); digitalWrite(IN2_H2, LOW);
  digitalWrite(IN3_H2, HIGH); digitalWrite(IN4_H2, LOW);

  ledcWrite(CH_H1_A, velocidad);
  ledcWrite(CH_H1_B, velocidad);
  ledcWrite(CH_H2_A, velocidad);
  ledcWrite(CH_H2_B, velocidad);
}

void derecha() {
  Serial.println("‚û°Ô∏è Derecha");

  digitalWrite(IN1_H1, HIGH); digitalWrite(IN2_H1, LOW);
  digitalWrite(IN3_H1, HIGH); digitalWrite(IN4_H1, LOW);

  digitalWrite(IN1_H2, LOW);  digitalWrite(IN2_H2, HIGH);
  digitalWrite(IN3_H2, LOW);  digitalWrite(IN4_H2, HIGH);

  ledcWrite(CH_H1_A, velocidad);
  ledcWrite(CH_H1_B, velocidad);
  ledcWrite(CH_H2_A, velocidad);
  ledcWrite(CH_H2_B, velocidad);
}

void detenerMotores() {
  Serial.println("üõë Detener motores");

  digitalWrite(IN1_H1, LOW); digitalWrite(IN2_H1, LOW);
  digitalWrite(IN3_H1, LOW); digitalWrite(IN4_H1, LOW);
  digitalWrite(IN1_H2, LOW); digitalWrite(IN2_H2, LOW);
  digitalWrite(IN3_H2, LOW); digitalWrite(IN4_H2, LOW);

  ledcWrite(CH_H1_A, 0);
  ledcWrite(CH_H1_B, 0);
  ledcWrite(CH_H2_A, 0);
  ledcWrite(CH_H2_B, 0);
}
