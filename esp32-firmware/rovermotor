#include <WiFi.h>
#include <WebServer.h>
#include <ArduinoOTA.h>
#include <PubSubClient.h>

// =================== Pines del L298N ===================
// PUENTE H #1 (4 motores en paralelo â†’ 2 motores lÃ³gicos)
const int IN1_H1 = 1;
const int IN2_H1 = 2;
const int IN3_H1 = 3;
const int IN4_H1 = 4;

// PUENTE H #2 (2 motores â†’ 2 motores lÃ³gicos)
const int IN1_H2 = 5;
const int IN2_H2 = 6;
const int IN3_H2 = 7;
const int IN4_H2 = 8;

// =================== Pines PWM ===================
const int PWM_H1_A = 9;
const int PWM_H1_B = 10;
const int PWM_H2_A = 11;
const int PWM_H2_B = 12;

// =================== Config PWM ===================
const int FREQ_PWM = 20000;
const int RES_PWM = 10;
int velocidad = 900; // <-- Ahora controlable vÃ­a MQTT

const int CH_H1_A = 0;
const int CH_H1_B = 1;
const int CH_H2_A = 2;
const int CH_H2_B = 3;

// =================== WiFi ===================
const char* ssid = "roverlunar";
const char* password = "rover123";

// =================== MQTT ===================
const char* mqtt_server = "192.168.1.100";
const int mqtt_port = 1883;

const char* mqtt_topic = "rover/control";   // Movimiento
const char* mqtt_topic_speed = "rover/speed"; // Velocidad PWM

const char* mqtt_client_id = "RoverESP32";

WiFiClient espClient;
PubSubClient mqttClient(espClient);

// =================== Servidor HTTP ===================
WebServer server(80);

// =================== Seguridad ===================
unsigned long ultimoComando = 0;
const unsigned long TIMEOUT_SEGURIDAD = 2000;
bool motorActivo = false;

// =================== Prototipos ===================
void adelante();
void atras();
void izquierda();
void derecha();
void detenerMotores();
void reconnectMQTT();
void callback(char* topic, byte* payload, unsigned int length);

// =================== SETUP ===================
void setup() {
  Serial.begin(115200);
  delay(300);

  // DirecciÃ³n L298N
  pinMode(IN1_H1, OUTPUT);
  pinMode(IN2_H1, OUTPUT);
  pinMode(IN3_H1, OUTPUT);
  pinMode(IN4_H1, OUTPUT);

  pinMode(IN1_H2, OUTPUT);
  pinMode(IN2_H2, OUTPUT);
  pinMode(IN3_H2, OUTPUT);
  pinMode(IN4_H2, OUTPUT);

  // PWM Setup
  ledcSetup(CH_H1_A, FREQ_PWM, RES_PWM);
  ledcSetup(CH_H1_B, FREQ_PWM, RES_PWM);
  ledcSetup(CH_H2_A, FREQ_PWM, RES_PWM);
  ledcSetup(CH_H2_B, FREQ_PWM, RES_PWM);

  ledcAttachPin(PWM_H1_A, CH_H1_A);
  ledcAttachPin(PWM_H1_B, CH_H1_B);
  ledcAttachPin(PWM_H2_A, CH_H2_A);
  ledcAttachPin(PWM_H2_B, CH_H2_B);

  detenerMotores();

  // =================== Conectar WiFi ===================
  Serial.println("Conectando al WiFi...");
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(300);
    Serial.print(".");
  }

  Serial.println("\nâœ… WiFi conectado!");
  Serial.print("IP: ");
  Serial.println(WiFi.localIP());

  // =================== MQTT ===================
  mqttClient.setServer(mqtt_server, mqtt_port);
  mqttClient.setCallback(callback);
  reconnectMQTT();

  // =================== Endpoints HTTP ===================
  server.on("/forward", []() { adelante(); ultimoComando = millis(); motorActivo = true; server.send(200, "text/plain", "Adelante"); });
  server.on("/backward", []() { atras(); ultimoComando = millis(); motorActivo = true; server.send(200, "text/plain", "Atras"); });
  server.on("/left", []() { izquierda(); ultimoComando = millis(); motorActivo = true; server.send(200, "text/plain", "Izquierda"); });
  server.on("/right", []() { derecha(); ultimoComando = millis(); motorActivo = true; server.send(200, "text/plain", "Derecha"); });
  server.on("/stop", []() { detenerMotores(); ultimoComando = millis(); motorActivo = false; server.send(200, "text/plain", "Stop"); });

  server.on("/", []() { server.send(200, "text/plain", "Rover OK - PWM Enabled + MQTT Speed"); });

  server.begin();
  Serial.println("ðŸŒ Servidor HTTP listo.");

  // =================== OTA ===================
  ArduinoOTA.setHostname("RoverMotor");
  ArduinoOTA.setPassword("123");

  ArduinoOTA.onStart([]() {
    detenerMotores();
    Serial.println("ðŸ”„ Iniciando actualizaciÃ³n OTA");
  });

  ArduinoOTA.onEnd([]() {
    Serial.println("\nâœ… OTA completada");
  });

  ArduinoOTA.begin();
  Serial.println("ðŸ“¡ OTA habilitado");
}

// =================== LOOP ===================
void loop() {
  ArduinoOTA.handle();
  if (!mqttClient.connected()) reconnectMQTT();
  mqttClient.loop();
  server.handleClient();

  unsigned long t = millis();

  if (motorActivo && t - ultimoComando > TIMEOUT_SEGURIDAD) {
    Serial.println("ðŸ›‘ TIMEOUT - Deteniendo por seguridad");
    detenerMotores();
    motorActivo = false;
  }

  delay(10);
}

// =================== MQTT CALLBACK ===================
void callback(char* topic, byte* payload, unsigned int length) {
  String msg = "";
  for (int i = 0; i < length; i++) msg += (char)payload[i];

  ultimoComando = millis();

  if (String(topic) == mqtt_topic) {
    Serial.println("ðŸ“© Movimiento: " + msg);

    if (msg == "forward") adelante();
    else if (msg == "backward") atras();
    else if (msg == "left") izquierda();
    else if (msg == "right") derecha();
    else if (msg == "stop") detenerMotores();
  }

  else if (String(topic) == mqtt_topic_speed) {
    velocidad = constrain(msg.toInt(), 0, 1023);
    Serial.print("âš¡ Nueva velocidad PWM: ");
    Serial.println(velocidad);
  }
}

// =================== MQTT RECONNECT ===================
void reconnectMQTT() {
  while (!mqttClient.connected()) {
    Serial.print("ðŸ”„ Conectando MQTT...");
    if (mqttClient.connect(mqtt_client_id)) {
      Serial.println("OK!");
      mqttClient.subscribe(mqtt_topic);
      mqttClient.subscribe(mqtt_topic_speed);
    } else {
      Serial.println("Error. Reintentando...");
      delay(1000);
    }
  }
}

// =================== MOVIMIENTOS ===================
void adelante() {
  Serial.println("â¬†ï¸ Adelante");

  digitalWrite(IN1_H1, HIGH); digitalWrite(IN2_H1, LOW);
  digitalWrite(IN3_H1, LOW);  digitalWrite(IN4_H1, HIGH);
  digitalWrite(IN1_H2, LOW);  digitalWrite(IN2_H2, HIGH);
  digitalWrite(IN3_H2, HIGH); digitalWrite(IN4_H2, LOW);

  ledcWrite(CH_H1_A, velocidad);
  ledcWrite(CH_H1_B, velocidad);
  ledcWrite(CH_H2_A, velocidad);
  ledcWrite(CH_H2_B, velocidad);
}

void atras() {
  Serial.println("â¬‡ï¸ Atras");

  digitalWrite(IN1_H1, LOW);  digitalWrite(IN2_H1, HIGH);
  digitalWrite(IN3_H1, HIGH); digitalWrite(IN4_H1, LOW);
  digitalWrite(IN1_H2, HIGH); digitalWrite(IN2_H2, LOW);
  digitalWrite(IN3_H2, LOW);  digitalWrite(IN4_H2, HIGH);

  ledcWrite(CH_H1_A, velocidad);
  ledcWrite(CH_H1_B, velocidad);
  ledcWrite(CH_H2_A, velocidad);
  ledcWrite(CH_H2_B, velocidad);
}

void izquierda() {
  Serial.println("â¬…ï¸ Izquierda");

  digitalWrite(IN1_H1, LOW);  digitalWrite(IN2_H1, HIGH);
  digitalWrite(IN3_H1, LOW);  digitalWrite(IN4_H1, HIGH);

  digitalWrite(IN1_H2, HIGH); digitalWrite(IN2_H2, LOW);
  digitalWrite(IN3_H2, HIGH); digitalWrite(IN4_H2, LOW);

  ledcWrite(CH_H1_A, velocidad);
  ledcWrite(CH_H1_B, velocidad);
  ledcWrite(CH_H2_A, velocidad);
  ledcWrite(CH_H2_B, velocidad);
}

void derecha() {
  Serial.println("âž¡ï¸ Derecha");

  digitalWrite(IN1_H1, HIGH); digitalWrite(IN2_H1, LOW);
  digitalWrite(IN3_H1, HIGH); digitalWrite(IN4_H1, LOW);

  digitalWrite(IN1_H2, LOW);  digitalWrite(IN2_H2, HIGH);
  digitalWrite(IN3_H2, LOW);  digitalWrite(IN4_H2, HIGH);

  ledcWrite(CH_H1_A, velocidad);
  ledcWrite(CH_H1_B, velocidad);
  ledcWrite(CH_H2_A, velocidad);
  ledcWrite(CH_H2_B, velocidad);
}

void detenerMotores() {
  Serial.println("ðŸ›‘ Detener motores");

  digitalWrite(IN1_H1, LOW);
  digitalWrite(IN2_H1, LOW);
  digitalWrite(IN3_H1, LOW);
  digitalWrite(IN4_H1, LOW);

  digitalWrite(IN1_H2, LOW);
  digitalWrite(IN2_H2, LOW);
  digitalWrite(IN3_H2, LOW);
  digitalWrite(IN4_H2, LOW);

  ledcWrite(CH_H1_A, 0);
  ledcWrite(CH_H1_B, 0);
  ledcWrite(CH_H2_A, 0);
  ledcWrite(CH_H2_B, 0);
}
